<template>
  <div v-if="project">
    <div class="tabs is-boxed mb-0 mt-2">
      <ul>
        <router-link :to="{ name: 'CubeProjectEdit' }" v-slot="{ href, isActive, navigate }" custom>
          <li :class="{ 'is-active': isActive }">
            <b-tooltip label="Project settings">
              <a :href="href" @click="navigate">
                <h2 class="has-text-weight-bold">
                  {{ project.title }}
                </h2>
                <b-icon icon="cog" class="ml-1" />
              </a>
            </b-tooltip>
          </li>
        </router-link>
        <router-link v-if="hasCSVMapping" :to="{ name: 'CSVMapping' }" v-slot="{ href, isActive, navigate }" custom>
          <li :class="{ 'is-active': isActive }">
            <a :href="href" @click="navigate">1. CSV Mapping</a>
          </li>
        </router-link>
        <router-link :to="{ name: 'CubeDesigner' }" v-slot="{ href, isActive, navigate }" custom>
          <li :class="{ 'is-active': isActive }">
            <a :href="href" @click="navigate">2. Cube Designer</a>
          </li>
        </router-link>
        <router-link :to="{ name: 'Publication' }" v-slot="{ href, isActive, navigate }" custom>
          <li :class="{ 'is-active': isActive }">
            <a :href="href" @click="navigate">
              3. Publication
            </a>
          </li>
        </router-link>
        <li class="tab-right pr-4" v-if="jobCollection">
          <transform-job-button :job-collection="jobCollection" :transform-jobs="transformJobs" />
        </li>
      </ul>
    </div>

    <page-content>
      <router-view />
    </page-content>
  </div>
  <loading-block v-else />
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator'
import { namespace } from 'vuex-class'
import { Job, JobCollection, Project } from '@cube-creator/model'
import PageContent from '@/components/PageContent.vue'
import LoadingBlock from '@/components/LoadingBlock.vue'
import TransformJobButton from '@/components/TransformJobButton.vue'

const projectNS = namespace('project')

@Component({
  components: { PageContent, LoadingBlock, TransformJobButton },
})
export default class CubeProjectView extends Vue {
  @projectNS.State('project') project!: Project | null;
  @projectNS.State('jobCollection') jobCollection!: JobCollection | null;
  @projectNS.Getter('transformJobs') transformJobs!: Job[];

  poller: number | null = null

  async mounted (): Promise<void> {
    const id = this.$router.currentRoute.params.id
    await this.$store.dispatch('project/fetchProject', id)

    // Poll jobs
    this.poller = window.setInterval(() => {
      this.$store.dispatch('project/fetchJobCollection')
    }, 3000)

    if (this.$router.currentRoute.name === 'CubeProject') {
      if (this.hasCSVMapping) {
        this.$router.push({ name: 'CSVMapping' })
      } else {
        this.$router.push({ name: 'CubeDesigner' })
      }
    }
  }

  beforeDestroy (): void {
    if (this.poller) {
      clearInterval(this.poller)
    }
  }

  get hasCSVMapping (): boolean {
    return !!this.project?.csvMapping
  }
}
</script>

<style scoped>
.tabs {
  /* Fix dropdown displayed under page content */
  overflow: visible;
}

.tab-right {
  margin-left: auto;
}

.tab-right ~ .tab-right {
  margin-left: 0;
}
</style>
